"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.compatibilityTest = void 0;
const startSupergraph_1 = require("./startSupergraph");
const testRunner_1 = require("./testRunner");
const promises_1 = require("fs/promises");
const markdown_1 = require("./utils/markdown");
const logging_1 = require("./utils/logging");
async function compatibilityTest(runtimeConfig) {
    (0, logging_1.logWithTimestamp)('******************************************************');
    (0, logging_1.logWithTimestamp)('Starting Apollo Federation Subgraph Compatibility Test');
    (0, logging_1.logWithTimestamp)('******************************************************');
    const testResults = {};
    // start supergraph
    const stopSupergraph = await (0, startSupergraph_1.startSupergraph)(runtimeConfig);
    try {
        // run tests
        const { assertionPassed } = await (0, testRunner_1.runJest)();
        for (const { assertion } of testRunner_1.TESTS) {
            testResults[assertion] = { success: assertionPassed(assertion) };
        }
        (0, logging_1.logWithTimestamp)('compatibility tests complete...');
    }
    catch (err) {
        (0, logging_1.logWithTimestamp)(`compatibility tests encountered an error: ${err}`);
    }
    finally {
        await stopSupergraph();
    }
    (0, logging_1.logWithTimestamp)('generating results...');
    if (runtimeConfig.format == 'markdown') {
        (0, markdown_1.generateSimplifiedMarkdown)(testResults, `results.md`);
    }
    else {
        await (0, promises_1.writeFile)(`results.json`, JSON.stringify(testResults, null, 2), 'utf-8');
    }
    (0, logging_1.logWithTimestamp)('compatibility test complete');
    // print results to console
    (0, logging_1.logResults)(testResults);
    process.exit(0);
}
exports.compatibilityTest = compatibilityTest;
//# sourceMappingURL=compatibilityTest.js.map